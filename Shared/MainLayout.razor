@inherits LayoutComponentBase
@inject SecurityService security

@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.DropDowns;
@using Syncfusion.Blazor.Inputs;
@using Syncfusion.Blazor.SplitButtons
@using Syncfusion.Licensing
@using System.Net.NetworkInformation;
@attribute [Authorize]

<Syncfusion.Blazor.Popups.SfDialogProvider />
@if (IsLoaded)
{
    <ErrorBoundary @ref="errorBoundary">
        <ChildContent>
            <CascadingValue Value="@session">
                <RadzenDialog />
                <RadzenNotification />
                <RadzenTooltip />
                <RadzenContextMenu />
                <AntContainer />
                <MudBlazor.MudThemeProvider />
                <MudBlazor.MudDialogProvider />
                <MudBlazor.MudSnackbarProvider />

                <PageTitle>BusinessWeb</PageTitle>

                @if (sc.IsAuthenticated())
                {
                    <RadzenLayout>
                        <RadzenHeader>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0" Style="width: 100%;">
                                <RadzenSidebarToggle Click="@(() => sidebarExpanded = !sidebarExpanded)" />
                                <RadzenMenu Class="ls-parent" Style="flex: 1;">
                                    <RadzenMenuItem Text="Applications" Icon="dashboard" Click="@(args => SelectAPP(0))" />
                                    <RadzenMenuItem Visible=@(session.SelectedAPP != 0) Text="@APP()" Icon="@Icon()" Path="/" />
                                    <!-- Societe Selection -->
                                    <RadzenMenuItem Class="ls-child-right" Text="@(session?.Societe?.Intitule ?? "Société")" Icon="home_filled">
                                        @foreach (TSociete item in societes)
                                        {
                                            <RadzenMenuItem Text="@item.Intitule" Click="@(args => SocieteSelected(item))" />
                                        }
                                    </RadzenMenuItem>

                                    <!-- User Menu -->
                                    <RadzenMenuItem Style="min-width: 130px;" Text="@sc.User?.Name" Icon="account_circle">
                                        <RadzenMenuItem Icon="settings" Click="Profile" Text="Profile" />
                                        @if (sc.IsInRole("Admin"))
                                        {
                                            <RadzenMenuItem Click="UtilisateursListe" Icon="person" Text="Utilisateurs" />
                                            <RadzenMenuItem Text="Sociétés" Icon="horizontal_split" Click="SocieteListe" />
                                            <RadzenMenuItem Icon="info" Text="Activation" Click="CheckActivation" />
                                        }
                                        <RadzenMenuItem Click="@(args => security.Logout())" Text="Logout" Icon="power_settings_new" />
                                    </RadzenMenuItem>
                                </RadzenMenu>
                            </RadzenStack>
                        </RadzenHeader>

                        <RadzenSidebar @bind-Expanded="@sidebarExpanded" Style="position: relative;">
                            @if (session.SelectedAPP == 0)
                            {
                                @BuildApplicationsDashboard()
                            }
                            else
                            {
                                @BuildAppSidebarMenu()
                            }
                        </RadzenSidebar>

                        <RadzenBody>
                            <div class="main-content">
                                @if (IsLicenseValid())
                                {
                                    @if (session.SelectedAPP == 0)
                                    {
                                        @BuildApplicationsGrid()
                                    }
                                    else
                                    {
                                        @if (HasAccessToCurrentPage())
                                        {
                                            @Body
                                        }
                                        else
                                        {
                                            <div class="center-screen">
                                                <Result Status="403" Title="403" SubTitle="Désolé, vous n'êtes pas autorisé à accéder à cette page.." />
                                            </div>
                                        }
                                    }
                                }
                                else
                                {
                                    <div class="center-screen">
                                        <Result Status="500" Title="License invalid" SubTitle="Merci de demander une license valide.." />
                                    </div>
                                }
                            </div>
                        </RadzenBody>
                    </RadzenLayout>
                }
                else
                {
                    <BusinessWeb.Pages.Default.Login></BusinessWeb.Pages.Default.Login>
                }
            </CascadingValue>
        </ChildContent>
        <ErrorContent Context="ex">
            <div style="padding: 2rem;">
                <RadzenCard>
                    <div style="padding: 1.5rem;">
                        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1rem">
                            <RadzenText Style="font-size: 1.25rem; font-weight: bold; color: #e74c3c;">
                                <RadzenIcon Icon="error" Style="margin-right: 0.5rem;" />
                                Erreur
                            </RadzenText>

                            <RadzenText Style="font-weight: bold;">
                                @ex.Message
                            </RadzenText>

                            <RadzenAccordion>
                                <Items>
                                    <RadzenAccordionItem Text="Détails techniques" Icon="code"
                                                         ExpandTitle="Afficher les détails techniques"
                                                         CollapseTitle="Masquer les détails techniques">
                                        <RadzenText Style="font-size: 0.8rem; white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                                            @ex.ToString()
                                        </RadzenText>
                                    </RadzenAccordionItem>
                                </Items>
                            </RadzenAccordion>

                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Style="margin-top: 1rem;">
                                <RadzenButton Click="@GoBack" Text="Accueil" Icon="home" />
                                <RadzenButton Click="@Reload" Text="Réessayer" Icon="refresh" ButtonStyle="ButtonStyle.Secondary" />
                            </RadzenStack>
                        </RadzenStack>
                    </div>
                </RadzenCard>
            </div>
        </ErrorContent>
    </ErrorBoundary>
}

@code {
    bool sidebarExpanded = true;
    [Parameter] public SessionDT session { get; set; } = new SessionDT();
    private List<TSociete> societes = new List<TSociete>();
    bool IsLoaded = false;
    ErrorBoundary errorBoundary;
    private CryptoLicense license = new CryptoLicense();
    private string macAddr;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(500);
        await InitializeLicense();
        await InitializeSession();
        IsLoaded = true;
    }

    private async Task InitializeLicense()
    {
        try
        {
            var row = sdb.TLicenses.FirstOrDefault() ?? new TLicense();
            license = new CryptoLicense(row.Activation, fn.validationKey);
            session.license = license;

            // Get MAC address
            macAddr = (
                from nic in NetworkInterface.GetAllNetworkInterfaces()
                where nic.OperationalStatus == OperationalStatus.Up
                select nic.GetPhysicalAddress().ToString()
            ).FirstOrDefault();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"License initialization error: {ex.Message}");
        }
    }
    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }
    private void Reload()
    {
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }
    private async Task InitializeSession()
    {
        if (sc.User != null)
        {
            try
            {
                societes = sdb.TSocietes
                    .FromSqlRaw("SELECT a.* FROM T_Societe a WHERE a.id IN (SELECT Societe FROM T_SocieteUser WHERE UserID = {0})", sc.User.Id)
                    .ToList();

                var user = sdb.AspNetUsers.FirstOrDefault(a => a.Id == sc.User.Id);
                session.Societe = societes.FirstOrDefault(a => a.id == user?.SelectedSociete) ?? societes.FirstOrDefault();

                // Set selected APP from user preferences
                session.SelectedAPP = user?.SelectedAPP ?? 0;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Session initialization error: {ex.Message}");
            }
        }

        await UpdateAuthorization();
    }

    private RenderFragment BuildAppMenuContent() => builder =>
    {
        var menuItems = fn.AuthItems()
            .Where(a => a.SelectedAPP == session.SelectedAPP)
            .GroupBy(a => a.Title)
            .ToList();

        foreach (var group in menuItems)
        {
            builder.OpenComponent(0, typeof(RadzenMenuItem));
            builder.AddAttribute(1, "Text", group.Key);
            builder.AddAttribute(2, "Icon", "folder");
            builder.AddAttribute(3, "ChildContent", (RenderFragment)(childBuilder =>
            {
                foreach (var item in group)
                {
                    if (!string.IsNullOrEmpty(item.Url))
                    {
                        childBuilder.OpenComponent(0, typeof(RadzenMenuItem));
                        childBuilder.AddAttribute(1, "Text", item.Description);
                        childBuilder.AddAttribute(2, "Path", item.Url);
                        childBuilder.AddAttribute(3, "Visible", IsVisible(item.Url));
                        childBuilder.CloseComponent();
                    }
                }
            }));
            builder.CloseComponent();
        }
    };

    private RenderFragment BuildApplicationsDashboard() => @<RadzenPanelMenu Style="width: 100%;" DisplayStyle="@(sidebarExpanded ? MenuItemDisplayStyle.IconAndText : MenuItemDisplayStyle.Icon)" ShowArrow="false">
@{
    var availableApps = GetAvailableApplications();

    foreach (var app in availableApps)
    {
    <RadzenPanelMenuItem Text="@app.Name" Icon="@app.Icon" Click="@(() => SelectAPP(app.Id??0))" />
    }
    }
</RadzenPanelMenu>;

private RenderFragment BuildAppSidebarMenu() => @<RadzenPanelMenu Multiple="false" Style="width: 100%;" DisplayStyle="@(sidebarExpanded ? MenuItemDisplayStyle.IconAndText : MenuItemDisplayStyle.Icon)" ShowArrow="false">
@{
    var authorizedItems = session.Authorizes?
    .Where(a => a.Visible && !string.IsNullOrEmpty(a.Url))
    .ToList() ?? new List<TAuthorize>();

    var groupedItems = fn.AuthItems()
    .Where(a => authorizedItems.Select(b => b.Url).Contains(a.Url) && a.SelectedAPP == session.SelectedAPP)
    .GroupBy(a => a.Title)
    .ToList();

    foreach (var titleGroup in groupedItems)
    {
        var titleIcon = titleGroup.First().TitleIcon;

            <RadzenPanelMenuItem Text="@titleGroup.Key" Icon="@titleIcon" Expanded="false">
                @{
                    // Group items by SousGroupe if HasSousGroupe is true
                    var sousGroupes = titleGroup
                    .Where(x => x.HasSousGroupe && !string.IsNullOrEmpty(x.SousGroupe))
                    .Select(x => x.SousGroupe)
                    .Distinct()
                    .ToList();

                    if (sousGroupes.Any())
                    {
                        // Items with SousGroupe
                        foreach (var sousGroupe in sousGroupes)
                        {
                            var sousGroupItems = titleGroup
                            .Where(x => x.SousGroupe == sousGroupe)
                            .ToList();

                            <RadzenPanelMenuItem Text="@sousGroupe" Expanded="false">
                                @foreach (var item in sousGroupItems)
                                {
                                    <RadzenPanelMenuItem Text="@item.Description" Path="@item.Url" />
                                }
                            </RadzenPanelMenuItem>
                        }

                        // Items without SousGroupe
                        var noSousGroupItems = titleGroup
                        .Where(x => !x.HasSousGroupe || string.IsNullOrEmpty(x.SousGroupe))
                        .ToList();

                        foreach (var item in noSousGroupItems)
                        {
                            <RadzenPanelMenuItem Text="@item.Description" Path="@item.Url" />
                        }
                    }
                    else
                    {
                        // No SousGroupe grouping needed
                        foreach (var item in titleGroup)
                        {
                            <RadzenPanelMenuItem Text="@item.Description" Path="@item.Url" />
                        }
                    }
                }
            </RadzenPanelMenuItem>
    }
}
</RadzenPanelMenu>;

private RenderFragment BuildApplicationsGrid() => @<div style="padding: 2rem;">
    <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="2rem" AlignItems="AlignItems.Center">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="1.5rem" JustifyContent="JustifyContent.Center">
            @foreach (var app in GetAvailableApplications())
            {
                var appInfo = fn.getApps().FirstOrDefault(a => a.Id == app.Id) ?? app;
                var appIndex = Array.IndexOf(GetAvailableApplications().ToArray(), app) + 1;
                <RadzenCard Style="width: 220px; background: white; box-shadow: 0px 0px 15px rgba(0,0,0,0.09); padding: 2.25rem; position: relative; overflow: hidden; cursor: pointer; border-radius: 30px !important;"
                            Class="app-card"
                            onclick="@(() => SelectAPP(app.Id??0))">

                    <!-- Icon container - Tailwind: fill-violet-500 w-12 -->
                    <div style="color: #8b5cf6; width: 48px; margin-bottom: 0.75rem !important;">
                        <RadzenIcon Icon="@appInfo.Icon" Style="font-size: 3rem !important;" />
                    </div>

                    <!-- App Name - Tailwind: font-bold text-xl -->
                    <RadzenLabel Text="@appInfo.Name" Style="font-weight: bold !important; font-size: 1.25rem !important; display: block !important; margin-bottom: 0.75rem !important; color: black !important; cursor: pointer !important;" />

                    <!-- App Description - Tailwind: text-sm text-zinc-500 leading-6 -->
                    <RadzenLabel Text="@appInfo.Description"
                                 Style="font-size: 10px !important; color: #71717a; line-height: 1.5 !important; display: block !important; cursor: pointer !important;" />

                </RadzenCard>
            }
        </RadzenStack>
    </RadzenStack>
</div>
        ;

    // Helper Methods
    private bool IsLicenseValid()
    {
        return (license.Status == LicenseStatus.Valid || license.MachineCodeAsString == macAddr) &&
               license.DateExpires.Date >= DateTime.UtcNow.Date;
    }

    private bool HasAccessToCurrentPage()
    {
    var currentUrl = NavigationManager.Uri.Replace(NavigationManager.BaseUri, "");
        if (string.IsNullOrEmpty(currentUrl) || currentUrl == "/")
            return true;

    return session?.Authorizes?.Any(a => a.Url == currentUrl && a.Visible) ?? false;
    }

private List<Items> GetAvailableApplications()
{
    var allApps = fn.getApps();
    return allApps
        .Where(app => license.IsFeaturePresentEx(app.Id ?? 0))
        .ToList();
}

private bool AppAvailable(int appId)
{
    // Check if user has any authorization for this app
    return session?.Authorizes?.Any(a => a.SelectedAPP == appId && a.Societe == session.Societe.id && a.Visible) ?? false;
}

private bool IsVisible(string url)
{
    return session?.Authorizes?.Any(a => a.Url == url && a.Visible) ?? false;
}
string setGridHeight(double height)
{
    string rs = "";
    rs = $"{height}vh";
    return rs;
}
private bool TitleIsVisible(string title)
{
    return session?.Authorizes?.Any(a => a.Title == title && a.Visible) ?? false;
}

private string Icon()
{
    var app = fn.getApps().FirstOrDefault(a => a.Id == session.SelectedAPP);
    return app?.Icon ?? "apps";
}

private string APP()
{
    var app = fn.getApps().FirstOrDefault(a => a.Id == session.SelectedAPP);
    return app?.Name ?? "Applications";
}

private async Task SelectAPP(int app)
{
    session.SelectedAPP = app;

    if (sc.User != null)
    {
        var user = sdb.AspNetUsers.FirstOrDefault(a => a.Id == sc.User.Id);
        if (user != null)
        {
            user.SelectedAPP = app;
            sdb.SaveChanges();
        }
    }

    await UpdateAuthorization();
    NavigationManager.NavigateTo("/");
}

private async Task SocieteSelected(TSociete ste)
{
    session.Societe = ste;
    session.SelectedAPP = 0;

    if (sc.User != null)
    {
        var user = sdb.AspNetUsers.FirstOrDefault(a => a.Id == sc.User.Id);
        if (user != null)
        {
            user.SelectedSociete = ste.id;
            sdb.SaveChanges();
        }
    }

    await UpdateAuthorization();
    NavigationManager.NavigateTo("/");
}

private async Task UpdateAuthorization()
{
    if (session?.Societe != null && sc.User != null)
    {
        try
        {
            var authUrls = fn.AuthItems().Select(b => b.Url).Where(url => !string.IsNullOrEmpty(url)).ToList();

            session.Authorizes = sdb.TAuthorizes
                .Where(a => a.Societe == session.Societe.id &&
                           a.UserID == sc.User.Id &&
                           a.SelectedAPP == session.SelectedAPP &&
                           a.Visible &&
                           authUrls.Contains(a.Url))
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Authorization update error: {ex.Message}");
            session.Authorizes = new List<TAuthorize>();
        }
    }
    else
    {
        session.Authorizes = new List<TAuthorize>();
    }
    StateHasChanged();
}

// Dialog methods
private async Task CheckActivation()
{
    await DialogService.OpenAsync<Activation>("Activation",
        new Dictionary<string, object>(),
        new Radzen.DialogOptions() { Width = "1000px", Height = "700px", CloseDialogOnEsc = true });
}

private async Task Profile()
{
    await DialogService.OpenAsync<BusinessWeb.Pages.Default.Users.Profile>(sc.User?.UserName,
        new Dictionary<string, object>(),
        new Radzen.DialogOptions() { Width = "800px", Height = "95%", CloseDialogOnEsc = true });
}

private async Task UtilisateursListe()
{
    await DialogService.OpenAsync<BusinessWeb.Pages.Default.Users.UsersListe>("Utilisateurs",
        new Dictionary<string, object>(),
        new Radzen.DialogOptions() { Width = "800px", Height = "90%", CloseDialogOnEsc = true });
}

private async Task SocieteListe()
{
    await DialogService.OpenAsync<BusinessWeb.Pages.Structure.Societes.SocietesListe>("Sociétés",
        new Dictionary<string, object>(),
        new Radzen.DialogOptions() { Width = "900px", Height = "90%", CloseDialogOnEsc = true });
}
}

<style>
    .app-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
        transition: all 0.3s ease;
        border-color: #1890ff;
    }

    .center-screen {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 70vh;
        padding: 2rem;
    }

    .main-content {
        height: 100%;
        min-height: calc(100vh - 60px);
    }

    /* Responsive design */
    @@media (max-width: 768px) {
        .main-content {
            padding: 0.5rem;
        }

        .center-screen {
            padding: 1rem;
        }
    }

    .grid-80 {
        height: @(setGridHeight(76));
    }

    .grid-90 {
        height: 86vh;
    }

    .grid-84 {
        height: @(setGridHeight(80));
    }

    .grid-78 {
        height: @(setGridHeight(74));
    }

    .grid-70 {
        height: @(setGridHeight(66));
    }

    .grid-67 {
        height: @(setGridHeight(60));
    }

    .grid-34 {
        height: @(setGridHeight(30));
    }

    .grid-50 {
        height: @(setGridHeight(48));
    }

    .grid-45 {
        height: @(setGridHeight(43));
    }

    .grid-40 {
        height: @(setGridHeight(38));
    }
</style>