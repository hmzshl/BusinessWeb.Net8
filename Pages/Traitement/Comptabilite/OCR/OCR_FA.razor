@page "/ocr-fa"
@attribute [Authorize]

@if (IsLoaded)
{
    <Card_1 Title="OCR - FACTURES ACHATS">
        <RadzenContent Container="main">
            <div class="grid-90">
                <SfToolbar>
                    <ToolbarItems>
                        <ToolbarItem OnClick=@(args => (DefaultGrid.OpenColumnChooserAsync(1, 1))) TooltipText="Colonnes selectionnées" Text="Colonnes selectionnées" ShowTextOn="DisplayMode.Overflow" Align="ItemAlign.Left" PrefixIcon="e-icons e-more-vertical-2"></ToolbarItem>
                        <ToolbarItem Align="ItemAlign.Left" Type="ItemType.Separator" />
                        <ToolbarItem Align="ItemAlign.Left" Type="ItemType.Input">
                            <Template>
                                <div style="margin-left: 5px; margin-right: 10px;" id="debut">
                                    <SfDatePicker ShowClearButton Placeholder="Date Début" Width="140px" TValue="DateTime ?" @bind-Value="date1" ShowTodayButton>
                                        <DatePickerEvents TValue="DateTime ?" ValueChange="@(args => UpdateGrid())"> </DatePickerEvents>
                                    </SfDatePicker>
                                </div>

                            </Template>
                        </ToolbarItem>
                        <ToolbarItem Align="ItemAlign.Left" Type="ItemType.Input">
                            <Template>
                                <div style="margin-left: 5px; margin-right: 10px;" id="fin">
                                    <SfDatePicker ShowClearButton Placeholder="Date Fin" Width="140px" TValue="DateTime ?" @bind-Value="date2" ShowTodayButton>
                                        <DatePickerEvents TValue="DateTime ?" ValueChange="@(args => UpdateGrid())"> </DatePickerEvents>
                                    </SfDatePicker>
                                </div>

                            </Template>
                        </ToolbarItem>
                        <ToolbarItem TooltipText="CHERCHE" Align="ItemAlign.Right" Overflow="OverflowOption.Show" Type="ItemType.Input">
                            <Template>
                                <SfTextBox Width="180px" Placeholder="RECHERCHE" ValueChanged="@(args => DefaultGrid.SearchAsync(args))"></SfTextBox>
                            </Template>
                        </ToolbarItem>
                        <ToolbarItem OnClick=@(args => (DefaultGrid.PrintAsync())) TooltipText="Imprimer" Text="Imprimer" ShowTextOn="DisplayMode.Overflow" Align="ItemAlign.Right" PrefixIcon="e-icons e-print"></ToolbarItem>
                        <ToolbarItem OnClick=@(args => (DefaultGrid.ExportToExcelAsync(fn.ExportToExcelAsync()))) TooltipText="Export Excel" Text="Export Excel" ShowTextOn="DisplayMode.Overflow" Align="ItemAlign.Right" PrefixIcon="e-icons e-export-excel"></ToolbarItem>
                        <ToolbarItem OnClick="Add" TooltipText="Ajouter" Text="Ajouter" ShowTextOn="DisplayMode.Overflow" Align="ItemAlign.Right" PrefixIcon="e-icons e-file-new"></ToolbarItem>
                    </ToolbarItems>
                </SfToolbar>
                <div class="grid-84" style="zoom: @session.zoomLevel;">
                    @if (loading)
                    {
                        <div class="center-screen">
                            <Loading_1 />
                        </div>
                    }
                    else
                    {
                        <SfGrid ID="EcritureGRID" EnablePersistence AllowFiltering AllowReordering AllowSorting Height="100%" AllowPaging
                                AllowResizing AllowSelection ShowColumnChooser="true" @ref="DefaultGrid" AllowPdfExport="true"
                                AllowExcelExport="true" DataSource="@items" EnableVirtualization>
                            <GridEditSettings Mode="Syncfusion.Blazor.Grids.EditMode.Dialog" />
                            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.CheckBox"></GridFilterSettings>
                            <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Multiple" />
                            <GridPageSettings PageSize="200"></GridPageSettings>
                            <GridEvents Created="CreatedHandler" TValue="API_V_ECRITUREC"></GridEvents>
                            <GridTemplates>
                                <EmptyRecordTemplate>
                                    <Empty></Empty>
                                </EmptyRecordTemplate>
                            </GridTemplates>
                            <GridColumns>
                                <GridColumn Width="40" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" HeaderText="Sta">
                                    <Template>
                                        @{
                                            var dt = (context as API_V_ECRITUREC);
                                            if (dt.EC_Cloture == 1)
                                            {
                                                <RadzenIcon Icon="lock" IconStyle="IconStyle.Success" />
                                            }
                                            else
                                            {
                                                <RadzenIcon Icon="lock_open" IconStyle="IconStyle.Primary" />
                                            }
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Format="dd/MM/yy" Width="70" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.MV_Date)" HeaderText="Date" />
                                <GridColumn Format="dd/MM/yy" Width="70" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_Echeance)" HeaderText="Date Ech" />
                                <GridColumn Width="70" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.JO_Num)" HeaderText="N° Jou" />
                                <GridColumn Width="150" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.JO_Intitule)" HeaderText="Journal" />
                                <GridColumn Width="70" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.CG_Num)" HeaderText="Compte" />
                                <GridColumn Width="150" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.CG_Intitule)" Visible="false" HeaderText="Intitulé Compte" />
                                <GridColumn Width="80" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_Piece)" HeaderText="Pièce" />
                                <GridColumn Width="80" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_RefPiece)" HeaderText="Numéro" />
                                <GridColumn Width="80" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.CT_Num)" HeaderText="N° Tiers" />
                                <GridColumn Width="200" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.CT_Intitule)" HeaderText="Tiers" />
                                <GridColumn Width="90" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_Reference)" HeaderText="Référence" />
                                <GridColumn Width="300" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_Intitule)" HeaderText="Libellé" />
                                <GridColumn Width="110" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.Debit)" HeaderText="Débit" Format="### ### ##0.00;-### ### ##0.00;#" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" />
                                <GridColumn Width="110" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.Credit)" HeaderText="Crédit" Format="### ### ##0.00;-### ### ##0.00;#" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" />
                                <GridColumn Width="40" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" HeaderText="LT">
                                    <Template>
                                        @{
                                            var dt = (context as API_V_ECRITUREC);
                                            if (dt.EC_Lettre == 1)
                                            {
                                                <RadzenIcon Icon="swap_horizontal_circle" IconStyle="IconStyle.Success" />
                                            }
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Width="70" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_Lettrage)" HeaderText="Lettre" Visible="false" />
                                <GridColumn Width="70" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_DateRappro)" Format="dd/MM/yy" HeaderText="DT Rap" Visible="false" />
                                <GridColumn Width="80" HeaderTextAlign="Syncfusion.Blazor.Grids.TextAlign.Center" Field="@nameof(API_V_ECRITUREC.EC_TresoPiece)" HeaderText="N° Rap" Visible="false" />

                            </GridColumns>
                        </SfGrid>
                    }

                </div>

            </div>
        </RadzenContent>
    </Card_1>
}
else
{
    <div class="center-screen">
        <Loading_1 />
    </div>
}




@code
{

    [CascadingParameter] public SessionDT session { get; set; } = new SessionDT();
    DB db = new DB();
    [Parameter] public string title { get; set; } = "";
    private SfGrid<API_V_ECRITUREC> DefaultGrid;
    bool IsLoaded = false;
    DateTime? date1 = new DateTime(DateTime.Today.Year, 1, 1);
    DateTime? date2;
    private List<API_V_ECRITUREC> items = new List<API_V_ECRITUREC>();
    bool loading = false;


    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(1);
        db = session.db;
        GC.Collect();
        await UpdateGrid();
        IsLoaded = true;

    }
    public void CreatedHandler(object args)
    {
        DefaultGrid.ClearFilteringAsync();
        DefaultGrid.ClearSortingAsync(); DefaultGrid.SearchAsync("");
    }

    private async Task UpdateGrid()
    {
        loading = true;
        await Task.Delay(100);
        items = db.API_V_ECRITUREC
        .Where(a => (
            (date1 != null && a.MV_Date >= date1) || date1 == null) && a.EC_Reference == "OCR"
            && ((date2 != null && a.MV_Date <= date2) || date2 == null)
                )
                .OrderByDescending(a => a.MV_Date)
                .ToList();

        loading = false;
        await Task.Delay(100);
    }

    private async Task ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }
    private async Task Add()
    {
        await DialogService.OpenAsync<AddDocument>("",
        new Dictionary<string, object>() { { "Type", "FA" } },
        new Radzen.DialogOptions() { Width = "95%", Height = "95%", CloseDialogOnEsc = false, Style = "max-width: 1500px;" });
        await UpdateGrid();
        await ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Opération réussie", Detail = "Opération réussie!", Duration = 2000 });
    }
}